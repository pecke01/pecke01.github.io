{"name":"Creating a native script for ElasticSearch","tagline":"Blog","body":"### Creating a Native script for ElasticSearch\r\n\r\nIn this post I will give a step by step introduction to how you can create your own native scripts for ElasticSearch. This is targeted for 0.20.0 and might need some adjusting for later releases. By native in ES we mean Java. ES supports other languages as well but in this case I will show how to create a native script that is loaded on startup. In this dummy case I will make a native scripts that reverts a String field.\r\nStep 1:\r\n\r\nImplement a class that implement NativeScriptFactory. In this class override the method newScript. I am gonna return an instance of a class called Reverted. It will take the Map params as arguments for it's constructor. \r\n```\r\npublic class CustomScriptFactory implements NativeScriptFactory {\r\n\r\n  @Override public ExecutableScript newScript (@Nullable Map params){\r\n    return new Reverted(params);\r\n  }\r\n}\r\n```\r\nStep 2:\r\n\r\nImplement the actual class that runs the script. In this case Reverted. I will give you an example of this class as well. It actually doesn't do a lot except reverts a field and returns it. My reverted class will extend the AbstractSearchScript and override the run method. It will also just get a substring of the reverted string to show that you can have several parameters to a script.\r\n```\r\npublic class Reverted extends AbstractSearchScript {\r\n  String fieldParam;\r\n  int lengthParam;\r\n  public Reverted(@Nullable Map params){\r\n    fieldParam = (String)params.get(\"field\");\r\n    lengthParam = new Integer(params.get(\"length\").toString()).intValue();\r\n  }\r\n\r\n  @Override\r\n  public Object run(){\r\n    if(doc().containsKey(fieldParam) && doc().field(fieldParam) != null && doc().field(fieldParam).getStringValue() != null) { \r\n         \r\n      String field = doc().field(fieldParam).getStringValue();\r\n      String reverse = new StringBuffer(field).reverse().toString();\r\n      \r\n      return reverse.substring(0, lengthParam); \r\n    }\r\n    else {           \r\n      return \"\";\r\n    }\r\n  }       \r\n}\r\n```\r\nStep 3:\r\n\r\nBuild and pack it into a JAR File that can be loaded.\r\n\r\n```\r\n$ javac -cp ..\\elasticsearch-0.19.8\\lib\\elasticsearch-0.19.8.jar .\\com\\marcus\\elasticsearch\\scripts\\*.java\r\n$ jar cf marcus-scripts-1.0.jar .\\com\\marcus\\elasticsearch\\scripts\\*.class\r\n```\r\n\r\nStep 4:\r\n\r\nAdd config row to elasticsearch.yml.\r\n\r\n```\r\nscript.native: revert.type: com.marcus.elasticsearch.scripts.CustomScriptFactory\r\n```\r\n\r\nStep 5:\r\n\r\nNow we are actually done. I place the created jar in the lib folder of my local ES and start it. We can now see if it works like we intended it to do. I index a document, the famous example from the ElasticSearch webpage.\r\n```\r\n$ curl -XPUT 'http://localhost:9200/twitter/tweet/1' -d '{\r\n    \"user\" : \"kimchy\",\r\n    \"post_date\" : \"2009-11-15T14:12:12\",\r\n    \"message\" : \"trying out Elastic Search\"\r\n}'\r\n```\r\nAfter I have indexed a document I query to see if the script works by calling the native script and reverting the message field.\r\n```\r\n$ curl -XPUT 'http://localhost:9200/twitter/_search' -d '{\r\n\"fields\" : [\"user\",\"message\"],\r\n \"query\" : {\r\n        \"term\" : { \"user\" : \"kimchy\" }\r\n    },\r\n    \"script_fields\": {\r\n        \"MessageReverted\": {\r\n            \"script\": \"revert\",\r\n            \"lang\": \"native\",\r\n            \"params\": {\r\n                \"field\": \"message\",\r\n                \"length\": 6\r\n            }\r\n        }\r\n    }\r\n}'\r\n```\r\n```\r\nRESULT:\r\n{\r\n    \"took\": 6,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 5,\r\n        \"successful\": 5,\r\n        \"failed\": 0\r\n    },\r\n    \"hits\": {\r\n        \"total\": 1,\r\n        \"max_score\": 0.30685282,\r\n        \"hits\": [{\r\n            \"_index\": \"twitter\",\r\n            \"_type\": \"tweet\",\r\n            \"_id\": \"1\",\r\n            \"_score\": 0.30685282,\r\n            \"fields\": {\r\n                \"message\": \"trying out Elastic Search\",\r\n                \"user\": \"kimchy\",\r\n                \"MessageReverted\": \"hcraeS\"\r\n            }\r\n        }]\r\n    }\r\n}\r\n```\r\nAs you can see the result is as we intended it to be. Hope this will help you out when creating a native script for ElasticSearch. We can do a lot with native scripts and remember that they will almost always be faster then sending in a script. It will also reduce bandwidth for you.\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}